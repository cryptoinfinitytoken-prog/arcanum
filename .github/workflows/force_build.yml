name: Arcanum Clean Source Build

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    # 1. Download OFFICIAL Monero Code (Ignores your broken repo files)
    - uses: actions/checkout@v4
      with:
        repository: monero-project/monero
        ref: v0.18.3.4
        submodules: recursive

    # 2. Install the Compiler Tools
    - name: Install Dependencies
      run: sudo apt update && sudo apt install -y build-essential cmake pkg-config libboost-all-dev libssl-dev libzmq3-dev libunbound-dev libsodium-dev libunwind8-dev liblzma-dev libreadline6-dev libldns-dev libexpat1-dev doxygen graphviz libpgm-dev qttools5-dev-tools libhidapi-dev libusb-1.0-0-dev libprotobuf-dev protobuf-compiler libudev-dev

    # 3. Apply Arcanum Identity (Surgical Modifications)
    - name: Brand the Code
      run: |
        # Change Name
        sed -i 's/CRYPTONOTE_NAME = "monero"/CRYPTONOTE_NAME = "arcanum"/' src/cryptonote_config.h
        
        # Change Ports
        sed -i 's/P2P_DEFAULT_PORT = 18080/P2P_DEFAULT_PORT = 19990/' src/cryptonote_config.h
        sed -i 's/RPC_DEFAULT_PORT = 18081/RPC_DEFAULT_PORT = 19991/' src/cryptonote_config.h
        
        # Change Nonce (Creates Unique Blockchain)
        sed -i 's/GENESIS_NONCE = 10000/GENESIS_NONCE = 7777/' src/cryptonote_config.h
        
        # Verify Changes (Print to log)
        grep -E "CRYPTONOTE_NAME|DEFAULT_PORT|GENESIS_NONCE" src/cryptonote_config.h

    # 4. Build Static Binary (Low Memory Mode to prevent crashes)
    - name: Compile Static
      run: make release-static -j1

    # 5. Find the files wherever they land
    - name: Locate Binaries
      run: |
        mkdir arcanum_output
        find build -name "monerod" -type f -exec cp {} arcanum_output/ \;
        find build -name "monero-wallet-cli" -type f -exec cp {} arcanum_output/ \;

    # 6. Upload the Victory Package
    - name: Upload Binaries
      uses: actions/upload-artifact@v4
      with:
        name: arcanum-linux-x64
        path: arcanum_output/
