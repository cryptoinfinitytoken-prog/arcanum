name: Arcanum Surgical Build

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Dependencies
      run: sudo apt update && sudo apt install -y build-essential cmake pkg-config libboost-all-dev libssl-dev libzmq3-dev libunbound-dev libsodium-dev libunwind8-dev liblzma-dev libreadline6-dev libldns-dev libexpat1-dev doxygen graphviz libpgm-dev qttools5-dev-tools libhidapi-dev libusb-1.0-0-dev libprotobuf-dev protobuf-compiler libudev-dev python3

    - name: Modify Config with Python (Safe Mode)
      run: |
        python3 -c '
        import re
        
        # Read the file
        with open("src/cryptonote_config.h", "r") as f:
            content = f.read()
        
        # 1. Change Name
        content = re.sub(r"CRYPTONOTE_NAME = \"monero\"", "CRYPTONOTE_NAME = \"arcanum\"", content)
        
        # 2. Change Ports (Mainnet)
        content = re.sub(r"P2P_DEFAULT_PORT = 18080", "P2P_DEFAULT_PORT = 19990", content)
        content = re.sub(r"RPC_DEFAULT_PORT = 18081", "RPC_DEFAULT_PORT = 19991", content)
        
        # 3. Change Nonce (Creates Unique Network)
        content = re.sub(r"GENESIS_NONCE = 10000", "GENESIS_NONCE = 7777", content)

        # Write it back
        with open("src/cryptonote_config.h", "w") as f:
            f.write(content)
        '

    - name: Compile Static
      run: make release-static -j2

    - name: Find and Move Binaries
      run: |
        mkdir arcanum_output
        # Find the binaries anywhere in the build folder
        find build -name "monerod" -type f -exec cp {} arcanum_output/ \;
        find build -name "monero-wallet-cli" -type f -exec cp {} arcanum_output/ \;

    - name: Upload Binaries
      uses: actions/upload-artifact@v4
      with:
        name: arcanum-linux-x64
        path: arcanum_output/
