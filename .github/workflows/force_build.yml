name: Arcanum Amnesia Build

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Dependencies
      run: sudo apt update && sudo apt install -y build-essential cmake pkg-config libboost-all-dev libssl-dev libzmq3-dev libunbound-dev libsodium-dev libunwind8-dev liblzma-dev libreadline6-dev libldns-dev libexpat1-dev doxygen graphviz libpgm-dev qttools5-dev-tools libhidapi-dev libusb-1.0-0-dev libprotobuf-dev protobuf-compiler libudev-dev

    - name: APPLY ARCANUM PATCHES (Identity + Amnesia)
      run: |
        # 1. Wipe the Checkpoints (The Amnesia Fix)
        # We overwrite the file that holds the old block hashes so it accepts ANY new history.
        echo '#include "checkpoints.h"' > src/checkpoints/checkpoints.cpp
        echo 'namespace cryptonote { using namespace epee; bool checkpoints::init_default_checkpoints(network_type nettype) { return true; } bool checkpoints::check_block(uint64_t height, const crypto::hash& h, bool& is_a_checkpoint) const { return true; } bool checkpoints::is_in_checkpoint_zone(uint64_t height) const { return false; } bool checkpoints::check_transaction_hashes(uint64_t height, const std::vector<crypto::hash>& tx_hashes) const { return true; } uint64_t checkpoints::get_max_height() const { return 0; } const std::map<uint64_t, crypto::hash>& checkpoints::get_points() const { static std::map<uint64_t, crypto::hash> empty_map; return empty_map; } bool checkpoints::is_alternative_block_allowed(uint64_t blockchain_height, uint64_t block_height, const crypto::hash *block_hash) { return true; } uint64_t checkpoints::get_min_height() const { return 0; } }' >> src/checkpoints/checkpoints.cpp

        # 2. Apply Config (The Identity Fix)
        rm src/cryptonote_config.h
        cat <<EOF > src/cryptonote_config.h
        #pragma once
        #include <string>
        #include <boost/uuid/uuid.hpp>
        #define CRYPTONOTE_DNS_TIMEOUT_MS 20000
        namespace config {
          uint64_t const CRYPTONOTE_PUBLIC_ADDRESS_BASE58_PREFIX = 239;
          uint64_t const CRYPTONOTE_PUBLIC_INTEGRATED_ADDRESS_BASE58_PREFIX = 240;
          uint64_t const CRYPTONOTE_PUBLIC_SUBADDRESS_BASE58_PREFIX = 241;
          uint16_t const P2P_DEFAULT_PORT = 19990;
          uint16_t const RPC_DEFAULT_PORT = 19991;
          uint16_t const ZMQ_RPC_DEFAULT_PORT = 19992;
          boost::uuids::uuid const NETWORK_ID = {{0x12,0x30,0xF1,0x71,0x61,0x04,0x41,0x61,0x17,0x31,0x00,0x82,0x16,0xA1,0xA1,0x10}};
          std::string const CRYPTONOTE_NAME = "arcanum";
          std::string const GENESIS_TX = "013c01ff0001ffffffffffff03029b2e4c0281c0b02e7c53291a94d1d0cbcf74ae0671a93d1d3080948a579ad83121017767aafcde9be00dcfd098715ebcf7f410daebc582fda69d24a28e9d0bc890d1";
          uint32_t const GENESIS_NONCE = 7777;
        }
        namespace config {
          namespace testnet {
            uint64_t const CRYPTONOTE_PUBLIC_ADDRESS_BASE58_PREFIX = 53;
            uint64_t const CRYPTONOTE_PUBLIC_INTEGRATED_ADDRESS_BASE58_PREFIX = 54;
            uint64_t const CRYPTONOTE_PUBLIC_SUBADDRESS_BASE58_PREFIX = 63;
            uint16_t const P2P_DEFAULT_PORT = 28080;
            uint16_t const RPC_DEFAULT_PORT = 28081;
            uint16_t const ZMQ_RPC_DEFAULT_PORT = 28082;
            boost::uuids::uuid const NETWORK_ID = {{0x12,0x30,0xF1,0x71,0x61,0x04,0x41,0x61,0x17,0x31,0x00,0x82,0x16,0xA1,0xA1,0x11}};
            std::string const GENESIS_TX = "013c01ff0001ffffffffffff03029b2e4c0281c0b02e7c53291a94d1d0cbcf74ae0671a93d1d3080948a579ad83121017767aafcde9be00dcfd098715ebcf7f410daebc582fda69d24a28e9d0bc890d1";
            uint32_t const GENESIS_NONCE = 10001;
          }
          namespace stagenet {
            uint64_t const CRYPTONOTE_PUBLIC_ADDRESS_BASE58_PREFIX = 53;
            uint64_t const CRYPTONOTE_PUBLIC_INTEGRATED_ADDRESS_BASE58_PREFIX = 54;
            uint64_t const CRYPTONOTE_PUBLIC_SUBADDRESS_BASE58_PREFIX = 63;
            uint16_t const P2P_DEFAULT_PORT = 38080;
            uint16_t const RPC_DEFAULT_PORT = 38081;
            uint16_t const ZMQ_RPC_DEFAULT_PORT = 38082;
            boost::uuids::uuid const NETWORK_ID = {{0x12,0x30,0xF1,0x71,0x61,0x04,0x41,0x61,0x17,0x31,0x00,0x82,0x16,0xA1,0xA1,0x12}};
            std::string const GENESIS_TX = "013c01ff0001ffffffffffff03029b2e4c0281c0b02e7c53291a94d1d0cbcf74ae0671a93d1d3080948a579ad83121017767aafcde9be00dcfd098715ebcf7f410daebc582fda69d24a28e9d0bc890d1";
            uint32_t const GENESIS_NONCE = 10002;
          }
        }
        EOF

    - name: Compile (Static)
      run: make release-static -j2

    - name: Upload Binaries
      uses: actions/upload-artifact@v4
      with:
        name: arcanum-linux-x64
        path: build/**/bin/*
